<!doctype html>
<html lang="en-us" manifest="rftg.appcache">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="icon" type="image/png" href="launcher-icon-2x.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="manifest" href="rftg.manifest.json">
    <meta name="viewport" content="width=1500, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>RFTG AI</title>
    <style>
@font-face {
    font-family: Oswald;
    src: url(fonts/Oswald-Regular.ttf);
}
@font-face {
    font-family: Oswald;
    src: url(fonts/Oswald-DemiBold.ttf);
    font-weight: bold;
}
body {
    font-family: Oswald, arial;
    background-color: #ddd;
    margin: 0;
    padding: 0;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
img {
    -webkit-touch-callout: none;
}
table {
    border-collapse: collapse;
}
@-webkit-keyframes popmove {
    from { -webkit-transform: scale(1.4);}
    to { -webkit-transform: scale(1);}
}

@keyframes popmove {
    from { transform: scale(1.4);}
    to { transform: scale(1);}
}
.modified {
  animation: popmove 1s;
  -webkit-animation: popmove 1s;
}

img.cardface {
    width:200px;
    height: 280px;
    position:absolute;
}
div.vptooltip {
    position:absolute;
    background-color: white;
    border-radius: 10px;
    left:49px;
    top:27px;
    width:17px;
    height:19px;
    text-align: center;
    font-size: 15px;
}
div.tradevalue {
    color: white;
    position:absolute;
    left:55px;
    top:75px;
    width:25px;
    height:20px;
    text-align: center;
    font-size: 18px;
}
div#savednum {
    position: absolute;
    width:24px;
    height:34px;
    top:18px;
    left:156px;
    border: 1px solid #666;
    border-radius: 4px;
    background-size: 100% 100%;
    color: #ddd;
    font-size: 25px;
    text-align: center;
}
img.good, img.prestigeaction {
    width:150px;
    position:absolute;
    left:50px;
    top:70px;
    box-shadow: 0 0 1px 1px #666;
    border-radius: 7px;
    transition: top .5s linear;
}
img.prestigeaction {
    display: none;
}
img.good.selected {
    box-shadow: 0 0 2px 2px gold;
}
img.discard {
    width: 100%;
    height: 100%;
    position: absolute;
    display: none;
}
.card.selected img.discard {
    display: block;
}
div.card div.frame {
    position: absolute;
    width: 100%;
    height: 100%;
    box-shadow: inset 0 0 2px 10px gold;
    display: none;
}
div.card.selected div.frame {
    display: block;
}
div.card div.cardaccel {
    position: absolute;
    height: 20px;
    color: #fff;
    background-color: rgba(0,0,0,.7);
    border-bottom-right-radius: 4px;
    padding: 0 5px;
    font-size: 14px;
}
div.card {
    margin: 5px;
    box-shadow: 0 0 2px 2px #444;
    position: absolute;
    display: block;
    overflow: hidden;
    border-radius: 10px;
    width: 200px;
    height: 280px;
    transition: left 1s linear, top 1s linear;
}
div.card.disabled {
    filter: grayscale(1) brightness(.4);
    -webkit-filter: grayscale(1) brightness(.4);
}
.player_color0 { background-color: #88a; }
.player_color1 { background-color: #a88; }
.player_color2 { background-color: #8a8; }
.player_color3 { background-color: #aa8; }
.player_color4 { background-color: #8aa; }
.player_color5 { background-color: #a8a; }
#loadingscreen {
    font-size: 50px;
    text-align: center;
}
#aboutscreen {
    font-size: 30px;
}
#menuscreen {
    font-size: 30px;
    text-align: center;
}
#settingsscreen, #campaignscreen {
    font-size: 30px;
    text-align: center;
}
#settingsscreen td:nth-child(odd) {
    text-align: right;
}
#settingsscreen td:nth-child(even) {
    text-align: left;
}
#settingsscreen .centeredscreen_i {
    width: 80%;
}
#settingsscreen table {
    margin: auto;
}
#cardpopup {
    text-align: center;
}
#cardpopup img {
    border-radius: 5% / 3.5%;
    height: 100%;
}
#cardpopup .centeredscreen_i {
    height: 95%;
    width: 95%;
}
#gameoverpopup {
    text-align: center;
    font-size: 32px;
}
#gameoverpopup table {
    margin: 0 auto;
    border: 2px solid black;
    border-collapse: collapse;
}
#gameoverpopup tr.player0 {
    font-size: 40px;
}
#gameoverpopup tr.head {
    font-size: 20px;
    background-color: #777;
}
#gameoverpopup td {
    position: relative;
    width: 50px;
    height: 50px;
    border: 1px solid #777;
}
#gameoverpopup tr span {
    position: relative;
}
#gameoverpopup tr img {
    position: absolute;
    width: 46px;
    height: 46px;
    top: 2px; left: 2px;
}

.centeredscreen_o {
    width: 100%;
    height: 100%;
    background: #aaa;
    position: fixed;
    top: 0;
}
.popup.centeredscreen_o {
    background: rgba(128,128,128,.7);
    z-index: 2;
}
.centeredscreen_i {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 50%;
    transform: translate(-50%,-50%);
    -webkit-transform: translate(-50%,-50%);
}
#progress {
    width: 100%;
    height: 50px;
    border: 3px solid black;
    padding: 3px;
    margin: 0 auto;
}
#progressbar {
    height: 100%;
    width: 0;
    background-color: black;
}
#promptcontainer {
    font-size: 30px;
    text-align: center;
    width: auto;
}
.deck {
    height: 290px;
    position: relative;
}
#saved.deck, #actionhand.deck {
    height: 0;
}
#table0.deck.showsaved {
    z-index: -1;
    height: 0;
}
#saved.deck.showsaved {
    height: 290px;
    background-color: #444;
}
td.icon, th.icon {
    position:relative;
    background-size:cover;
    background-repeat:no-repeat;
    width:50px;
    height:50px;
    text-shadow: -1px -1px #ccc, -1px 1px #ccc, 1px -1px #ccc, 1px 1px #ccc;
    text-align:center;
    border: 2px solid rgba(0,0,0,0);
}
.icon div.military > div, .icon div.military {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%);
    -webkit-transform: translate(-50%,-50%);
}
.icon div.military {
    width:39px;
    height:39px;
    color: #ed1c24;
    font-size: 22px;
    border-radius: 50%;
    font-weight: bold;
    border: 3.5px solid #ed1c24;
    text-shadow: none;
    background-color: #fff;
}
.icon div.military.vsrebel {
    color: #fff;
    text-shadow: -1.5px -1.5px #ed1c24, -1.5px 1.5px #ed1c24, 1.5px -1.5px #ed1c24, 1.5px 1.5px #ed1c24;
    border: 3.5px solid #ed1c24;
    background-color: #fabfac;
}
.icon div.hasrebel, .icon div.hasimperium {
    width:16px;
    height:16px;
    border-radius:50%;
    margin:2px;
}
.icon div.hasrebel {
    border:2.5px solid #ed1c24;
    background-color: #fabfac;
}
.icon div.hasimperium {
    border:2.5px solid #8c2b99;
    background-color: #be86ca;
}
td.goal div {
    height: 50px;
    border-radius:5px;
    overflow: hidden;
    margin: 1px;
    box-shadow: 0 0 1px 1px #fb0;
}
td.goal div img {
    width: 44px;
}
td.goalbig div img {
    transform: translate(0,-24%);
    -webkit-transform: translate(0,-24%);
}
td.goal1 {
    filter: grayscale(1) brightness(.8);
    -webkit-filter: grayscale(1) brightness(.8);
}
.icon.inactiveaction {
    opacity: .1;
    filter: grayscale(1);
    -webkit-filter: grayscale(1);
}
.icon.currentaction div {
    border-radius: 6px;
    width: 100%;
    height: 100%;
    box-shadow: inset 0 0 3px 2px red;
}
.icon.p_used {
    filter: grayscale(1) brightness(2.5);
    -webkit-filter: grayscale(1) brightness(2.5);
}
.prestige {
  width:100%;
  height:100%;
}
.prestige div {
  position: absolute;
  font-weight: bold;
  font-size: 25px;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  -webkit-transform: translate(-50%,-50%);
}
.icon.p_leader.p_turn .modified {
  width:100%;
  height:100%;
}
.icon.p_leader.p_turn .prestige {
    position: absolute;
    top: 0;
    left: 0;
    border: 2.5px solid white;
    border-radius: 50%;
    width: 46px;
    height: 46px;
}
span.modalopt {
display: inline-block;
}

input::-webkit-outer-spin-button,input::-webkit-inner-spin-button {
    -webkit-appearance: none;
}
input#menu_seed {
    -moz-appearance:textfield;
    width: 130px;
}
input#menu_seed, button, select, .menu, span.modalopt {
border: 2px solid #333; background: #666;
border-radius: 10px;
color: #ccc;
padding: 0 10px;
margin: 1px;
font-size: 30px;
font-family: Oswald, arial;
cursor: default;
}
span.modalopt.selected, button.selected {
background: #88a;
border: 2px solid yellow;
}
button:disabled {
border: 2px solid #999; background: #aaa;
color: #999;
}
img.buttonicon {
height:40px;
vertical-align:text-bottom;
margin: 0 -8px;
}
.buttonicon_container {
position:relative;
}
img.buttonicon_prestige {
position:absolute;
height:20px;
right:-8px;
bottom:0;
display:none;
}
img.prestige_icon {
position:absolute;
height:24px;
right:0;
bottom:0;
}
.modalopt.selected_1 img.buttonicon_prestige, .modalopt.selected_1 img.prestigeaction {
display:inline-block;
}
.modalopt .kind {
    display: inline-block;
    width:32px;
    height:32px;
    border-radius: 50%;
    border: 2.5px solid #000;
    vertical-align:text-bottom;
    margin: 5px -3px;
}
.modalopt .kind2 { background-color: #80d6f7; }
.modalopt .kind3 { background-color: #daa566; }
.modalopt .kind4 { background-color: #80cc28; }
.modalopt .kind5 { background-color: #fff200; }
#menu {
 position:absolute;
 right:0;
 z-index:1;
 width:160px;
}
.gamelog {
text-align: left;
border: 2px solid #333; background: rgba(100,100,100,0.95);
border-radius: 10px;
color: #ccc;
padding: 0 10px;
margin: 1px;
font-size: 16px;
font-family: Oswald, arial;
-webkit-user-select: text;
-moz-user-select: text;
-ms-user-select: text;
user-select: text;
height:640px;
width:400px;
overflow-y:scroll;
position:absolute;
right:0;
z-index:1;
}
.logline.em {
text-align: center;
font-weight:bold;
color: #f66;
}
.logline.phase {
text-align: center;
color: #f66;
}
.logline.discard, .logline.draw, .logline.verbose {
color: #888;
}
#goals {
text-align: left;
border: 2px solid #333; background: rgba(100,100,100,0.95);
border-radius: 10px;
position:absolute;
left:0;
top:0;
z-index:1;
}
#goals img {
  width: 120px;
  border-radius: 10px;
  margin: 3px;
}
#goals th.claimed img {
  filter: grayscale(1) brightness(0.8);
  -webkit-filter: grayscale(1) brightness(0.8);
}
#goals th {
padding: 0px;
vertical-align: bottom;
}
#goals td {
color: #000;
text-align: left;
font-size: 20px;
padding: 1.5px;
}
#goals span {
display: inline-block;
text-align: right;
border-radius: 10px;
}
#goals span.player0.player_color0 { background-color: #44a; color: #fff; }
#goals span.player0.player_color1 { background-color: #e02; color: #fff; }
#goals span.player0.player_color2 { background-color: #080; color: #fff; }
#goals span.player0.player_color3 { background-color: #ee0; }
#goals span.player0.player_color4 { background-color: #088; color: #fff; }
#goals span.player0.player_color5 { background-color: #808; color: #fff; }
#board {
overflow: hidden;
position: relative;
width: 100%;
-webkit-tap-highlight-color: rgba(0,0,0,0);
}
.player {
width: 100%;
}
#status_over {
position: fixed;
bottom: 0;
width: 100%;
}
#status_over div.hidden {
overflow: hidden;
height: 0px;
display: block;
}
h1 {
text-align: center;
}
#menu_button {
    width: 52px;
}
.hidden {
    display: none;
}
.big input#menu_seed, .big button, .big select, .big .menu, .big span.modalopt { font-size: 50px; }
.big #menu { width:260px; }
.big img.buttonicon { height:66px; }
.big #promptcontainer { height:80px; }
.big #goalsbutton td.goal div { height:75px; }
.big #goalsbutton td.goal div img { width: 67px; }
.big #menu_button { width: 66px; }
.big .gamelog { width: 600px; font-size: 24px; }
#cachecontainer {
position: fixed;
top: 0;
border: 2px solid black;
margin: 2px;
background-color: white;
color: black;
font-size: 22px;
width: 100px;
height: 30px;
z-index: 1000;
text-align: center;
}
#cacheprogress {
position: absolute;
height: 100%;
background-color: black;
overflow: hidden;
}
#cacheprogress div {
color: white;
width: 100px;
}
    </style>
  </head>
  <body class="big">
<div class="screen centeredscreen_o" id="loadingscreen">
   <div class="centeredscreen_i">
<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 1000 1000">
<path style="fill:#daa566" d="m500,500v-500a500,500 0 0,1 500,500z" />
<path style="fill:#fff200" d="m500,500h500a500,500 0 0,1 -500,500z" />
<path style="fill:#80cc28" d="m500,500v500a500,500 0 0,1 -500,-500z" />
<path style="fill:#80d6f7" d="m500,500h-500a500,500 0 0,1 500,-500z" />
<g><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 500 500" to="360 500 500" dur="4s" repeatCount="indefinite" />
<path style="fill:#231f20" d="m500,150a350,350 0 0,0 0,700z" />
<path style="fill:#ed1c24" d="m500,150a350,350 0 0,1 0,700z" />
</g>
<circle style="fill:#fff" cx="500" cy="500" r="225" />
</svg>
   <div id="progress">
    <div id="progressbar">
    </div>
   </div>
   <div id="loadingmsg">Loading...</div>
   </div>
</div>
<div class="screen hidden" id="gamescreen">
<table style="width:100%"><tr><td>
 <table><tr><td>
  <table><tr id="action_status"></table>
 </td><td>
  <span data-accel="71" onclick="var m=document.getElementById('goals');m.classList.toggle('hidden');m.scrollTop=m.scrollHeight" style="position:relative;display:inline-block">
  <span id="goalsbutton"></span><div id="goals" class="hidden"></div></span>
 </td></table>
</td><td style="text-align:right">
 <button id="restart_undo" data-accel="ctrl-90" onclick="GUI.do_undo(GUI.RESTART.UNDO)">Undo</button>
 <span style="position:relative;display:inline-block">
 <button data-accel="76" onclick="var m=document.getElementById('gamelog');m.classList.toggle('hidden');m.scrollTop=m.scrollHeight">Log</button><div class="gamelog hidden" id="gamelog">
 <table id="gamelogtext"></table>
 </div></span>
 <span style="position:relative;display:inline-block">
 <button id="menu_button" onclick="document.getElementById('menu').classList.toggle('hidden')"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="2 2 20 20">
 <path style="fill:#ccc" d="M6,15h12c0.553,0,1,0.447,1,1v1c0,0.553-0.447,1-1,1H6c-0.553,0-1-0.447-1-1v-1C5,15.447,5.447,15,6,15z M5,11v1
    c0,0.553,0.447,1,1,1h12c0.553,0,1-0.447,1-1v-1c0-0.553-0.447-1-1-1H6C5.447,10,5,10.447,5,11z M5,6v1c0,0.553,0.447,1,1,1h12
    c0.553,0,1-0.447,1-1V6c0-0.553-0.447-1-1-1H6C5.447,5,5,5.447,5,6z"/>
 </svg>
 </button><div class="menu hidden" id="menu" onclick="document.getElementById('menu').classList.add('hidden')">
 <div data-accel="ctrl-shift-90" onclick="GUI.do_undo(GUI.RESTART.UNDO_ROUND)">Undo Round</div>
 <div onclick="GUI.do_undo(GUI.RESTART.UNDO_GAME)">Restart Game</div>
 <div data-accel="ctrl-78" onclick="GUI.do_undo(GUI.RESTART.NEW)">New Game</div>
 <div data-accel="27" onclick="GUI.set_screen('menuscreen')">Exit Game</div>
 <div onclick="GUI.set_screen('settingsscreen')">Settings</div>
 <div style="position:relative">Export Save<a data-accel="ctrl-83" style="position:absolute;width:100%;height:100%;top:0;left:0" id="exportsavelink" target="_blank" download="save.rftg"></a></div>
 <div style="position:relative">Import Save<input data-accel="ctrl-79" onchange="GUI.do_importsave(this.files[0])" style="position:absolute;width:100%;height:100%;top:0;left:0;opacity:0" type="file"></div>
 <div onclick="GUI.set_screen('aboutscreen')">About</div>
 </div></span>
</td></table>
<table><tr><td><table><tr id="game_status"></tr></table></td><td id="promptcontainer"><span id="actionprompt"></span> <button data-accel="13" id="actionbutton" onclick="GUI.do_send()">Done</button></td></tr></table>
<div id="board" onclick="GUI.do_click(event)">
    <div id="player0" class="player player0">
     <div class="deck" id="actionhand"></div>
     <div class="deck" id="hand"></div>
     <table><tr id="player_status0"></tr></table>
     <div id="player_status0"></div>
     <div class="deck" id="saved"></div>
     <div class="deck" id="table0"></div>
    </div>
    <div id="player1" class="player player1"><table><tr id="player_status1"></tr></table><div class="deck" id="table1"></div></div>
    <div id="player2" class="player player2"><table><tr id="player_status2"></tr></table><div class="deck" id="table2"></div></div>
    <div id="player3" class="player player3"><table><tr id="player_status3"></tr></table><div class="deck" id="table3"></div></div>
    <div id="player4" class="player player4"><table><tr id="player_status4"></tr></table><div class="deck" id="table4"></div></div>
    <div id="player5" class="player player5"><table><tr id="player_status5"></tr></table><div class="deck" id="table5"></div></div>
</div>
<div id="status_over">
    <div id="player_over0" class="player0"><table><tr id="player_status_over0"></tr></table></div>
    <div id="player_over1" class="player1"><table><tr id="player_status_over1"></tr></table></div>
    <div id="player_over2" class="player2"><table><tr id="player_status_over2"></tr></table></div>
    <div id="player_over3" class="player3"><table><tr id="player_status_over3"></tr></table></div>
    <div id="player_over4" class="player4"><table><tr id="player_status_over4"></tr></table></div>
    <div id="player_over5" class="player5"><table><tr id="player_status_over5"></tr></table></div>
</div>
<div data-accel="192" onclick="GUI.toggle_showaccels()"></div>
</div>
<div class="hidden screen centeredscreen_o" id="aboutscreen"><div class="centeredscreen_i">
<p>This is a program to play Race for the Galaxy against AI players.  Rules
for the game and expansions can be found at:
<a href="http://riograndegames.com/getFile.php?id=273">Base Game</a>,
<a href="http://riograndegames.com/getFile.php?id=293">The Gathering Storm</a>,
<a href="http://riograndegames.com/getFile.php?id=393">Rebel vs Imperium</a>,
<a href="http://riograndegames.com/getFile.php?id=506">The Brink of War</a>,
<a href="http://riograndegames.com/getFile.php?id=1813">Alien Artifacts</a>.
<p>This program was created by Keldon Jones keldon@keldon.net.  Many
useful improvements, especially to the GUI, were made by B. Nordli (BGG user borgemik).
<br>JavaScript/HTML port by nutki@BGG.
<p>The source code is copyrighted and is placed under the GPL.
<p>The original game of Race for the Galaxy was designed by Tom Lehmann and
published by Rio Grande Games.  Permission to distribute the card and
goal images has been granted by Rio Grande Games.
<h1><button data-accel="27" onclick="GUI.set_screen('gamescreen')">Back</button></h1>
</div></div>
<div class="hidden screen centeredscreen_o" id="menuscreen"><div class="centeredscreen_i">
<h1>RACE FOR THE GALAXY AI</h1>
<select onchange="GUI.update_menu()" id="menu_exp_level">
<option value="0">Base Game only</option>
<option value="1">The Gathering Storm</option>
<option value="2">Rebel vs Imperium</option>
<option value="3">The Brink of War</option>
<option value="4">Alien Artifacts</option>
</select>
<select onchange="GUI.update_menu()" id="menu_num_players">
<option value="2">2 Players</option>
<option value="3">3 Players</option>
<option value="4">4 Players</option>
<option value="5">5 Players</option>
<option value="6">6 Players</option>
</select><br>
<button onclick="this.classList.toggle('selected')" id="menu_advanced">Advanced</button>
<button onclick="this.classList.toggle('selected')" id="menu_goals">Goals</button>
<button onclick="this.classList.toggle('selected')" id="menu_takeovers">Takeovers</button>
<button onclick="this.classList.toggle('selected');GUI.update_menu()" id="menu_seedset">Custom Seed</button>
<input class="hidden" type="number" id="menu_seed">
<h1>
<button data-accel="27" onclick="GUI.set_screen('gamescreen')">Return</button>
<button onclick="GUI.set_screen('campaignscreen')">Scenarios</button>
<button data-accel="13" onclick="GUI.do_startgame()">Start Game</button>
</h1>
</div></div>
<div class="hidden screen centeredscreen_o" id="settingsscreen"><div class="centeredscreen_i">
<h2>Settings</h2>
<table><tr><td>
Card animations</td><td><select id="setting_anim">
<option value="0">No</option>
<option value="1">Yes</option>
</select></td><td>
Auto confirm actions</td><td><select id="setting_autoconfirm">
<option value="0">No</option>
<option value="1">Yes</option>
</select></td><tr><td>
Keep status bars on screen</td><td><select id="setting_pullup">
<option value="0">No</option>
<option value="1">Yes</option>
</select></td><td>
Start world choice</td><td><select id="setting_revstart">
<option value="0">Select</option>
<option value="1">Discard</option>
</select></td><tr><td>
Shortcut keys</td><td><select id="setting_accels">
<option value="0">F1 - F12, 1 - 0</option>
<option value="1">1 - 0, Q - P</option>
</select></td><td>
First player color</td><td><select id="setting_color">
<option value="0">Blue</option>
<option value="1">Red</option>
<option value="2">Green</option>
<option value="3">Yellow</option>
<option value="4">Cyan</option>
<option value="5">Purple</option>
</select></td><tr><td>
Use action cards</td><td><select id="setting_actioncards">
<option value="0">No</option>
<option value="1">Yes</option>
</select></td><td>
Big buttons</td><td><select id="setting_bigbody">
<option value="0">No</option>
<option value="1">Yes</option>
</select></td></table>
<h2><button data-accel="13" onclick="GUI.save_settings();GUI.set_screen('gamescreen')">Return</button></h2>
</div></div>
<div class="hidden screen centeredscreen_o" id="campaignscreen"><div class="centeredscreen_i">
<h2>Scenarios</h2>
<select id="campaign_name"></select><p id="campaign_info"></p>
<h1>
<button data-accel="27" onclick="GUI.set_screen('menuscreen')">Return</button>
<button data-accel="13" onclick="GUI.do_startcampaign()">Start Game</button>
</h1>
</div></div>
<div class="hidden popup screen centeredscreen_o" id="cardpopup" onclick="GUI.set_screen('gamescreen')" oncontextmenu="event.preventDefault()"><div class="centeredscreen_i">
<img id="cardpopupimg" data-accel="27" onclick="GUI.set_screen('gamescreen')">
</div></div>
<div class="hidden popup screen centeredscreen_o" id="gameoverpopup"><div class="centeredscreen_i">
<table id="gamesummary"></table><br>
<button data-accel="27" onclick="GUI.set_screen('gamescreen')">Return</button>
<button data-accel="ctrl-78" onclick="GUI.set_screen('gamescreen');GUI.do_undo(GUI.RESTART.NEW);">New Game</button>
<button data-accel="13" onclick="GUI.set_screen('menuscreen');">Exit Game</button>
</div></div>
<div id="cachecontainer" hidden>
<div id="cacheprogress"><div id="cachestatus1"></div></div>
<div id="cachestatus2"></div>
</div>
<script>window.onerror = function(msg, src, line) { alert('ERROR ' + line + ': ' + msg); };</script>
<script type='text/javascript'>
var GUI = (function() {
  var GUI = {};
  function hide(el, val) {
    if (val !== undefined) {
      if (val) el.classList.add('hidden');
      else el.classList.remove('hidden');
    }
    return el.classList.contains('hidden');
  }
  var update_menu = GUI.update_menu = function() {
    var ea = document.getElementById('menu_exp_level');
    var eb = document.getElementById('menu_num_players');
    var ec = document.getElementById('menu_advanced');
    var ed = document.getElementById('menu_goals');
    var ee = document.getElementById('menu_takeovers');
    var ef = document.getElementById('menu_seedset');
    var eg = document.getElementById('menu_seed');
    var maxp = [4, 5, 6, 6, 5][ea.value];
    for (var i = 0; i < 5; i++)
      eb.options[i].disabled = i + 2 > maxp;
    if (eb.value > maxp) eb.selectedIndex = 0;
    hide(ec, eb.value > 2);
    hide(ed, [0, 1, 1, 1, 0][ea.value] === 0);
    hide(ee, [0, 0, 1, 1, 0][ea.value] === 0);
    hide(eg, !ef.classList.contains('selected'));
  }

  function init_menu() {
    var ea = document.getElementById('menu_exp_level');
    var eb = document.getElementById('menu_num_players');
    var ec = document.getElementById('menu_advanced');
    var ed = document.getElementById('menu_goals');
    var ee = document.getElementById('menu_takeovers');
    ea.selectedIndex = exp_level;
    eb.selectedIndex = num_players - 2;
    if (advanced) ec.classList.add('selected');
    if (goals) ed.classList.add('selected');
    if (takeovers) ee.classList.add('selected');
    update_menu();
  }

  var do_startgame = GUI.do_startgame = function() {
    var ec = document.getElementById('menu_advanced');
    var ed = document.getElementById('menu_goals');
    var ee = document.getElementById('menu_takeovers');
    var menu_num_players = document.getElementById('menu_num_players').value;
    var menu_exp_level = document.getElementById('menu_exp_level').value;
    var menu_advanced = !hide(ec) && ec.classList.contains('selected');
    var menu_goals = !hide(ed) && ed.classList.contains('selected');
    var menu_takeovers = !hide(ee) && ee.classList.contains('selected');
    var menu_seed = document.getElementById('menu_seedset').classList.contains('selected') ?
      document.getElementById('menu_seed').value : undefined;
    if (menu_exp_level == exp_level && menu_num_players == num_players &&
      menu_advanced == advanced && menu_goals == goals &&
      menu_takeovers == takeovers && menu_seed === undefined && campaign === undefined) {
      set_screen('loadingscreen');
      do_undo(RESTART.NEW);
      return;
    }
    var loc = "#num_players=" + menu_num_players + '&exp_level=' + menu_exp_level;
    if (menu_advanced) loc += '&advanced';
    if (!menu_goals) loc += '&nogoals';
    if (!menu_takeovers) loc += '&notakeovers';
    if (menu_seed !== undefined) loc += '&seed=' + menu_seed;
    location = loc;
    location.reload();
  }
  var do_startcampaign = GUI.do_startcampaign = function() {
    var e = document.getElementById('campaign_name');
    if (e.value === "") return;
    var c = campaigns[e.value];
    if (c.name === campaign) {
      set_screen('loadingscreen');
      do_undo(RESTART.NEW);
      return;
    }
    var loc = "#num_players=" + c.options[1] + '&exp_level=' + c.options[0];
    if (c.options[2]) loc += '&advanced';
    if (c.options[3]) loc += '&nogoals';
    if (c.options[4]) loc += '&notakeovers';
    loc += "&campaign=" + encodeURIComponent(c.name);
    location = loc;
    location.reload();
  }
  var settings = {
    animate: 1,
    autoconfirm: true,
    pullup: true,
    revstart: true,
    accels: 0,
    color: 0,
    actioncards: false,
    bigbody: false,
  };
  var save_settings = GUI.save_settings = function() {
    settings = {
      animate: parseInt(document.getElementById('setting_anim').value),
      autoconfirm: document.getElementById('setting_autoconfirm').value === "1",
      pullup: document.getElementById('setting_pullup').value === "1",
      revstart: document.getElementById('setting_revstart').value === "1",
      accels: parseInt(document.getElementById('setting_accels').value),
      color: parseInt(document.getElementById('setting_color').value),
      actioncards: document.getElementById('setting_actioncards').value === "1",
      bigbody: document.getElementById('setting_bigbody').value === "1",
    }
    if (localStorage)
      localStorage.setItem('rftg.conf', JSON.stringify(settings));
    update_player_classes();
  }

  function load_settings() {
    var saved_settings = localStorage && localStorage.getItem('rftg.conf');
    if (saved_settings) {
      settings = JSON.parse(saved_settings);
      if (!('accels' in settings)) settings.accels = 0;
      if (!('color' in settings)) settings.color = 0;
    }
    document.getElementById('setting_anim').selectedIndex = settings.animate;
    document.getElementById('setting_autoconfirm').selectedIndex = settings.autoconfirm ? 1 : 0;
    document.getElementById('setting_pullup').selectedIndex = settings.pullup ? 1 : 0;
    document.getElementById('setting_revstart').selectedIndex = settings.revstart ? 1 : 0;
    document.getElementById('setting_accels').selectedIndex = settings.accels;
    document.getElementById('setting_color').selectedIndex = settings.color;
    document.getElementById('setting_actioncards').selectedIndex = settings.actioncards ? 1 : 0;
    document.getElementById('setting_bigbody').selectedIndex = settings.bigbody ? 1 : 0;
  }
  function set_save_params(s) {
    if (!s) return false;
    var m = s.match(/^RFTG Save\n0.9.4\n\d+\n(\d+) (\d+)\n(\d+) (\d+) (\d+)\n(.*?)\n/);
    if (!m) return false;
    num_players = parseInt(m[1]);
    exp_level = parseInt(m[2]);
    advanced = m[3] === '1';
    goals = exp_level >= 1 && exp_level <= 3 && m[4] !== '1';
    takeovers = exp_level >= 2 && exp_level <= 3 && m[5] !== '1';
    campaign = m[6] === 'none' ? undefined : m[6];
    return true;
  }
  GUI.do_importsave = function (file) {
    if (!file) return;
    var reader = new FileReader();
    reader.onloadend = function (ev) {
      if (!(ev.target.readyState === FileReader.DONE)) return;
      if (!set_save_params(ev.target.result)) return;
      localStorage.setItem('autosave.rftg', ev.target.result);
      location.reload();
    }
    reader.readAsText(file.slice());
  }

  function card_popup(cid) {
    document.getElementById('cardpopupimg').src = image_from_data(card_info[cid].image);
    set_screen('cardpopup');
  }
  var set_screen = GUI.set_screen = function(s) {
    update_key_accels(document.getElementById(s));
    var popup = document.getElementById(s).classList.contains('popup');
    if (popup) {
      document.getElementById(s).classList.remove('hidden');
      return;
    }
    var scrs = document.getElementsByClassName('screen');
    for (var i = 0; i < scrs.length; i++) {
      scrs[i].classList.add('hidden');
    }
    document.getElementById(s).classList.remove('hidden');
    console.log(s);
    set_scroll();
  }
  var RESTART = GUI.RESTART = {
    NEW: 1,
    NONE: 2,
    LOAD: 3,
    RESTORE: 4,
    UNDO: 5,
    UNDO_ROUND: 6,
    UNDO_GAME: 7,
    REDO: 8,
    REDO_ROUND: 9,
    REDO_GAME: 10,
    REPLAY: 11,
    CURRENT: 12,
  };
  var CHOICE = {
    ACTION: 0,
    START: 1,
    DISCARD: 2,
    SAVE: 3,
    DISCARD_PRESTIGE: 4,
    PLACE: 5,
    PAYMENT: 6,
    SETTLE: 7,
    TAKEOVER: 8,
    DEFEND: 9,
    TAKEOVER_PREVENT: 10,
    UPGRADE: 11,
    TRADE: 12,
    CONSUME: 13,
    CONSUME_HAND: 14,
    GOOD: 15,
    LUCKY: 16,
    ANTE: 17,
    KEEP: 18,
    WINDFALL: 19,
    PRODUCE: 20,
    DISCARD_PRODUCE: 21,
    SEARCH_TYPE: 22,
    SEARCH_KEEP: 23,
    OORT_KIND: 24,
  };
  var SCAVENGERS = 157;

  var card_info = [];
  var decks;
  var game_status;
  var num_players = 2;
  var exp_level = 0;
  var advanced = false;
  var goals = false;
  var takeovers = false;
  var images = [];
  var images_data;
  var campaigns = [];
  var campaign = undefined;
  var game_over = false;
  var select;
  var selectable_cards;
  var select_autoconfirm;
  var action_cards;
  var save;
  var params = [];
  if (location.hash) {
    var url_params = {};
    location.hash.substring(1).split('&').forEach(function(e) {
      var pair = e.split('=', 2);
      if (pair[0]) url_params[pair[0]] = pair[1];
    });
    if (url_params.num_players) {
      num_players = parseInt(url_params.num_players);
      params.push('-p', url_params.num_players);
    }
    if (url_params.exp_level) {
      exp_level = parseInt(url_params.exp_level);
      params.push('-e', url_params.exp_level);
    }
    if ('advanced' in url_params && num_players == 2) {
      advanced = true;
      params.push('-a');
    }
    if ('nogoals' in url_params) {
      goals = false;
      params.push('-nog');
    } else {
      goals = exp_level >= 1 && exp_level <= 3;
    }
    if ('notakeovers' in url_params) {
      takeovers = false;
      params.push('-not');
    } else {
      takeovers = exp_level >= 2 && exp_level <= 3;
    }
    if ('seed' in url_params) {
      params.push('-r', url_params.seed);
    }
    if ('campaign' in url_params) {
      var campaign = decodeURIComponent(url_params.campaign);
      params.push('-c', campaign);
    }
    history.replaceState({}, document.title, window.location.pathname);
  } else {
    var s = localStorage && localStorage.getItem('autosave.rftg');
    if (set_save_params(s)) save = s;
  }
  init_menu();
  load_settings();
  update_player_classes();
  for (var i = num_players; i < 6; i++) {
    hide(document.getElementById('player' + i), true);
    hide(document.getElementById('player_over' + i), true);
  }

  var svg_images = {
    3001:'<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="400" height="400"><g transform="translate(0,-652.36218)"><g transform="matrix(17.474816,0,0,-17.474816,-2114.3111,8696.8945)"><g transform="translate(1.0604453,4.6836332)"><g transform="translate(131.377,438.99)"><path d="M 0,0 C 4.245,0 7.997,2.014 10.332,5.103 7.997,8.191 4.245,10.205 0,10.205 -4.246,10.205 -7.997,8.191 -10.332,5.103 -7.997,2.014 -4.246,0 0,0 z" style="fill:#918f90;stroke:#231f20;stroke-width:0.36000001;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /></g><g transform="translate(136.479,444.093)"><path d="m 0,0 c 0,-2.818 -2.284,-5.103 -5.102,-5.103 -2.818,0 -5.102,2.285 -5.102,5.103 0,2.818 2.284,5.102 5.102,5.102 C -2.284,5.102 0,2.818 0,0 z" style="fill:#ffffff;stroke:#231f20;stroke-width:0.36000001;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /></g><g transform="translate(130.167,443.527)"><path d="m 0,0 0,-0.922 -0.703,0 0,0.922 -0.927,0 0,0.703 0.927,0 0,0.921 0.703,0 0,-0.921 0.922,0 L 0.922,0 0,0 z" style="fill:#231f20;fill-opacity:1;fill-rule:nonzero;stroke:none" /></g><g transform="translate(133.859,442.582)"><path d="m 0,0 c -0.184,-0.184 -0.478,-0.333 -0.904,-0.333 -0.426,0 -0.737,0.149 -0.916,0.327 -0.254,0.254 -0.311,0.553 -0.334,0.853 l 0.749,0 c 0.039,-0.322 0.19,-0.507 0.501,-0.507 0.144,0 0.265,0.04 0.357,0.133 0.132,0.132 0.162,0.351 0.162,0.61 0,0.473 -0.14,0.737 -0.502,0.737 -0.306,0 -0.443,-0.172 -0.495,-0.333 l -0.686,0 0,2.315 2.339,0 0,-0.674 -1.659,0 0,-0.881 c 0.11,0.104 0.34,0.207 0.616,0.207 0.34,0 0.599,-0.109 0.766,-0.276 C 0.316,1.855 0.363,1.469 0.363,1.083 0.363,0.622 0.299,0.3 0,0" style="fill:#231f20;fill-opacity:1;fill-rule:nonzero;stroke:none" /></g></g></g></g></svg>',
    3002:'<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="400" height="400"><g transform="translate(0,-652.36218)"><g transform="matrix(21.424411,0,0,-21.424411,200.10832,947.0261)"><path d="M 0,0 C 3.354,0 6.319,1.591 8.164,4.033 6.319,6.473 3.354,8.064 0,8.064 -3.355,8.064 -6.319,6.473 -8.164,4.033 -6.319,1.591 -3.355,0 0,0 z" style="fill:#918f90;stroke:#231f20;stroke-width:0.36000001;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /></g><g transform="matrix(21.424411,0,0,-21.424411,286.4701,860.62145)"><path d="m 0,0 c 0,-2.227 -1.805,-4.033 -4.031,-4.033 -2.227,0 -4.032,1.806 -4.032,4.033 0,2.226 1.805,4.031 4.032,4.031 C -1.805,4.031 0,2.226 0,0 z" style="fill:#ffffff;stroke:#231f20;stroke-width:0.36000001;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /></g><g transform="matrix(21.424411,0,0,-21.424411,179.13381,870.21958)"><path d="m 0,0 0,-0.691 -0.527,0 0,0.691 -0.696,0 0,0.527 0.696,0 0,0.691 0.527,0 0,-0.691 0.691,0 L 0.691,0 0,0 z" style="fill:#231f20;fill-opacity:1;fill-rule:nonzero;stroke:none" /></g><g transform="matrix(21.424411,0,0,-21.424411,208.82804,890.20856)"><path d="m 0,0 0,0.476 0.519,0 0,1.995 -0.627,-0.544 0,0.605 0.627,0.544 0.561,0 0,-2.6 0.48,0 L 1.56,0 0,0 z" style="fill:#231f20;fill-opacity:1;fill-rule:nonzero;stroke:none" /></g></g></svg>',
    3003:'<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="400" height="400"><g transform="scale(8.7) translate(-391.5,-481)"><path d="m 429.774,504.472 -15.182,-18.161 -15.182,18.161 15.182,18.349" style="fill:#fde3b8;fill-opacity:1;fill-rule:nonzero;stroke:none" /><path d="M 430.353,504.951 415.17,523.3 c -0.3,0.363 -0.856,0.363 -1.156,0 l -15.183,-18.349 c -0.232,-0.277 -0.229,-0.683 0.003,-0.961 l 15.183,-18.161 c 0.3,-0.36 0.85,-0.36 1.15,0 l 15.183,18.161 c 0.232,0.278 0.235,0.684 0.003,0.961 z m -15.761,-17.47 -14.207,16.994 14.207,17.167 14.207,-17.167" style="fill:#231f20;fill-opacity:1;fill-rule:nonzero;stroke:none" /></g></svg>',
    3005:'<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="400" height="400"><g transform="scale(1.05) translate(0,-652.36218)"><g transform="matrix(15.122002,0,0,-15.122002,-857.02675,5090.9016)"><g transform="matrix(1.2545353,0,0,1.2545353,-15.531153,-73.357456)"><g transform="translate(75.798,282.417)"><path d="m 0,0 c 0,-4.509 -3.655,-8.164 -8.162,-8.164 -4.508,0 -8.163,3.655 -8.163,8.164 0,4.509 3.655,8.163 8.163,8.163 C -3.655,8.163 0,4.509 0,0 z" style="fill:#ffffff;stroke:#231f20;stroke-width:1.08000004;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /></g><g transform="translate(67.636,290.58)"><path d="m 0,0 c 4.507,0 8.162,-3.654 8.162,-8.163 0,-4.509 -3.655,-8.164 -8.162,-8.164" style="fill:none;stroke:#ed1c24;stroke-width:1.08000004;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /></g></g></g></g></svg>',
    3023:'<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="400" height="400"><path d="m 203.0475,290.71378 c 73.95737,0 139.33835,-35.05801 179.99374,-88.88366 -40.65539,-53.82565 -106.03637,-88.88367 -179.99374,-88.88367 -73.95735,0 -139.291312,35.05802 -179.993734,88.88367 40.702422,53.82565 106.036384,88.88366 179.993734,88.88366 z" style="fill:#918f90;stroke:#231f20;stroke-width:6.27155828;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /><path d="m 291.9782,201.83012 c 0,49.07495 -39.82439,88.88366 -88.9307,88.88366 -49.05926,0 -88.88367,-39.80871 -88.88367,-88.88366 0,-49.05927 39.82441,-88.88367 88.88367,-88.88367 49.10631,0 88.9307,39.8244 88.9307,88.88367 z" style="fill:#ffffff;stroke:#231f20;stroke-width:6.27155828;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /></svg>',
  }
  function image_from_data(nr) {
    var binary = '';
    if (svg_images[nr]) return 'data:image/svg+xml;base64,' + btoa(svg_images[nr]);
    var len = images[nr].len;
    for (var i = 0; i < len; i++) {
      binary += String.fromCharCode(images_data[i + images[nr].pos]);
    }
    return 'data:image/jpeg;base64,' + window.btoa(binary);
  }

  function target_card(c) {
    while (!c.id && c.parentNode) c = c.parentNode;
    if (c.id && c.id.match(/^card\d+$/)) return c;
    return undefined;
  }
  function target_action(c) {
    while (!c.id && c.parentNode) c = c.parentNode;
    if (c.id && c.id.match(/^modalopt\d+$/)) return c;
    return undefined;
  }
  function toggle_showsaved(ev) {
    document.getElementById('table0').classList.toggle('showsaved');
    document.getElementById('saved').classList.toggle('showsaved');
    display(false);
    ev.stopPropagation();
  }
  var do_click = GUI.do_click = function(ev) {
    var c, t;
    if (ev.target.id === 'shownum' || document.getElementById('table0').classList.contains('showsaved')) {
      toggle_showsaved(ev);
      return;
    }
    if (c = target_action(ev.target)) {
      onclick_modal(parseInt(c.id.substring(8)));
      return;
    }
    if (!(c = target_card(ev.target))) return;
    if (!(t = selectable_cards[card_id(c)])) return;
    if (t === 'good') {
      var notsel = c.querySelector('.good:not(.selected)');
      if (notsel) notsel.classList.add('selected');
      else {
        var good = c.querySelectorAll('.good');
        for (var i = 0; i < good.length; i++) good[i].classList.remove('selected');
      }
    } else c.classList.toggle('selected');
    update_action_sensitivity();
  }
  document.getElementById('board').addEventListener('contextmenu', function(ev) {
    var c;
    if (!(c = target_card(ev.target))) return;
    card_popup(card_id(c));
    ev.preventDefault();
  });
  var long_touch, long_touch_x, long_touch_y;
  function do_touch(ev) {
    if (ev.touches.length === 1) {
      var c = target_card(ev.touches[0].target);
      if (c) long_touch = window.setTimeout(function() {
        card_popup(card_id(c));
        long_touch = undefined;
      }, 1000);
      long_touch_x = ev.touches[0].clientX;
      long_touch_y = ev.touches[0].clientY;
    } else {
      if (long_touch) window.clearTimeout(long_touch);
      long_touch = undefined;
    }
  }
  document.getElementById('board').addEventListener('touchstart', do_touch);
  document.getElementById('board').addEventListener('touchend', do_touch);
  document.getElementById('board').addEventListener('touchcancel', do_touch);
  document.getElementById('board').addEventListener('touchmove', function(ev) {
    if (Math.abs(long_touch_x - ev.touches[0].clientX) > 10 ||
        Math.abs(long_touch_y - ev.touches[0].clientY) > 10) {
      if (long_touch) window.clearTimeout(long_touch);
      long_touch = undefined;
    }
  });

  function set_prompt(txt) {
    document.getElementById('actionprompt').innerHTML = txt;
  }

  function get_cards_selected(where, not) {
    var src = document.getElementById(where || 'board');
    var sel = not ? '.card:not(.selected)' : '.selected';
    return Array.prototype.map.call(src.querySelectorAll(sel), card_id);
  }

  function card_id(e) {
    return parseInt((e.id || e.parentNode.id).substring(4));
  }

  function plural(v) {
    return v === 1 ? '' : 's';
  }
  var action_restrict, select_result;

  function update_action_sensitivity(initial) {
    var res = action_restrict();
    var ac = select_autoconfirm && settings.autoconfirm;
    hide(document.getElementById('actionbutton'), game_over || !res && ac);
    document.getElementById('actionbutton').disabled = !res;
    if (res && ac && !initial) do_send();
  }

  function restrict_num(action_min, action_max) {
    if (action_max === 1) select_autoconfirm = true;
    return function() {
      var s = get_cards_selected().length;
      return s >= action_min && s <= action_max;
    };
  }
  var modalresult;
  var modallimit;
  var modalvalues;
  var card_classes;
  var onclick_modal = GUI.onclick_modal = function(idx) {
    var i, j, v = modalvalues[idx],
      pos = -1,
      next;
    for (i = 0; i < v.length; i++) {
      pos = modalresult.indexOf(v[i]);
      if (pos >= 0) break;
    }
    next = pos < 0 ? 0 : i + 1;
    if (pos < 0) i = -1;
    if (pos >= 0) modalresult.splice(pos, 1);
    if (next < v.length) modalresult.unshift(v[next]);
    modalresult.splice(modallimit, 1);
    var opts = document.getElementsByClassName('modalopt');
    for (i = 0; i < opts.length; i++) {
      var ci = parseInt(opts[i].id.substring(8));
      var s = modalvalues[ci];
      opts[i].classList.remove('selected');
      for (j = 0; j < modalvalues[ci].length; j++) {
        if (modalresult.indexOf(modalvalues[ci][j]) >= 0) {
          opts[i].classList.add('selected', 'selected_' + j);
        } else {
          opts[i].classList.remove('selected_' + j);
        }
      }
    }
    update_action_sensitivity();
  }

  function KEYACCELS(t) {
    return [
      [ 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, "shift-112", "shift-113", "shift-114", "shift-115", "shift-116", "shift-117", "shift-118", "shift-119", "shift-120", "shift-121", "shift-122", "shift-123" ],
      [ 49, 50, 51, 52, 53, 54, 55, 56, 57, 48, "shift-49", "shift-50", "shift-51", "shift-52", "shift-53", "shift-54", "shift-55", "shift-56", "shift-57", "shift-48" ],
      [ 81, 87, 69, 82, 84, 89, 85, 73, 79, 80, "shift-81", "shift-87", "shift-69", "shift-82", "shift-84", "shift-89", "shift-85", "shift-73", "shift-79", "shift-80" ]
    ][ (settings.accels ? 1 : 0) + (t ? 1 : 0) ];
  }
  function ACTIONKEY() {
    return [
      [ 117, 112, 'shift-112', 113, 'shift-113', 114, 'shift-114', 115, 'shift-115', 116 ],
      [ 54, 49, 'shift-49', 50, 'shift-50', 51, 'shift-51', 52, 'shift-52', 53 ]
    ][settings.accels ? 1 : 0];
  }
  function gen_modal(options, num) {
    modallimit = num || 1;
    modalresult = [];
    modalvalues = [];
    var html = '';
    options.forEach(function(e, i) {
      modalvalues[i] = e.value instanceof Array ? e.value : [e.value];
      html += '<span id="modalopt' + i + '" onclick="GUI.onclick_modal(' + i + ')" class="modalopt" data-accel="' + (e.accel || KEYACCELS(0)[i]) + '">' + e.name + '</span>';
    });
    return html;
  }
  function gen_select(options) {
    return '<select id="userselect">' + options.map(function(e, i) {
      var key = KEYACCELS(0)[i] ? ' data-accel="' + KEYACCELS(0)[i] + '"' : '';
      return '<option value="' + i + '"' + key + '>' + e.name + '</option>';
    }).join('') + '</select>';
  }
  function select_value() { return parseInt(document.getElementById('userselect').value); }

  function makebuttonicon(id) {
    var has_prestige = id instanceof Array;
    if (has_prestige) id = id[0];
    if (id === 4 || id === 6) id--;
    var txt = '<img class="buttonicon" src="' + image_from_data(3000 + id) + '">';
    if (has_prestige) txt = '<span class="buttonicon_container">' + txt + '<img class="buttonicon_prestige" src="' + image_from_data(3014) + '"></span>';
    return txt;
  }
  GUI.toggle_hand = function () {
    var h1 = document.getElementById('hand');
    var h2 = document.getElementById('actionhand');
    h1.style.zIndex = -1 - h1.style.zIndex;
    h2.style.zIndex = -1 - h2.style.zIndex;
  }

  function no_select() {
    selectable_cards = {};
    action_cards = undefined;
    card_classes = {};
    select_autoconfirm = true;
    action_restrict = function() {
      return false;
    };
    set_prompt('Thinking...');
  }
  function do_select() {
    selectable_cards = {};
    action_cards = undefined;

    function make_selectable(list, type) {
      list.forEach(function(e) {
        selectable_cards[e] = type || 'normal';
      });
    }
    function make_selectable_power(list, phase) {
      if (game_status.current_phase === undefined) return;
      var phase = (advanced ? [1, 2, 2, 3, 3, 4, 5] : [1, 2, 3, 4, 5])[game_status.current_phase];
      list.forEach(function(e) {
        selectable_cards[e] = card_info[e].discard & (1 << phase) ? 'discard' : 'normal';
      });
    }

    function make_inactive(where) {
      decks[where].forEach(function(e) {
        if (!selectable_cards[e.index]) card_classes[e.index] = 'disabled';
      });
    }
    card_classes = {};
    select_autoconfirm = false;
    action_restrict = function() {
      return true;
    };
    select_result = function() {
      return {
        list: get_cards_selected()
      };
    };
    if (!select) {
      set_prompt('<button onclick="GUI.set_screen(\'gameoverpopup\')">Game Over</button>');
      set_screen('gameoverpopup');
      action_restrict = function() {
        return false;
      };
    } else if (select.type === CHOICE.DISCARD) {
      var discard = select.arg1;
      var select_all = 2 * discard - select.list.length > 1;
      if (select_all)
        select.list.forEach(function(e) {
          card_classes[e] = 'selected';
        });
      set_prompt('Choose ' + discard + ' card' + plural(discard) + ' to discard');
      make_selectable(select.list, 'discard');
      make_inactive('hand');
      action_restrict = restrict_num(discard, discard);
    } else if (select.type === CHOICE.ACTION) {
      var one = select.arg1;
      var to_select = advanced && !one ? 2 : 1;
      var can_prestige = Module._can_prestige();
      var opts = advanced ? [1, 2, 3, 4, 5, 6, 7, 8, 9] : [1, 2, 3, 5, 7, 8, 9];
      if (one === 2) {
        var first = select.list[0];
        opts = opts.filter(function(e) {
          return e !== (first & 127);
        });
        if (!first || (first & 128)) can_prestige = 0;
      }
      if (can_prestige & 2) opts = opts.map(function(e) {
        return [e, e | 128];
      }); // Add prestige actions
      if (can_prestige & 1) opts.unshift(0); // Add search action;
      opts = opts.map(function(e) {
        return {
          name: makebuttonicon(e),
          value: e,
          accel: ACTIONKEY()[e instanceof Array ? e[0] : e]
        };
      });
      select_autoconfirm = !advanced && exp_level !== 3;
      var name = advanced ? ['actions', 'first action', 'second action'][one] : 'action';
      var modal = gen_modal(opts, to_select);
      if (settings.actioncards) {
        action_cards = opts;
        name += ' <button data-accel="32" onclick="GUI.toggle_hand()">Show hand</button>';
      } else {
        name += ': ' + modal;
      }
      set_prompt('Choose ' + name);
      action_restrict = function() {
        var r = modalresult;
        var prestige_action = r.filter(function(e) {
          return (e & 128) || !e;
        });
        if (prestige_action.length > 1) return false; // No double prestige
        return r.length === to_select;
      }
      select_result = function() {
        var r = modalresult.slice();
        if (one === 2) r.unshift(select.list[0]);
        if (r.length === 1) r.push(-1);
        // fix second develop or settle without the first
        if ((r[0] === 4 || r[0] === 6) && r[1] !== r[0] - 1) r[0]--;
        if ((r[1] === 4 || r[1] === 6) && r[0] !== r[1] - 1) r[1]--;
        return {
          result: one,
          list: r
        };
      }
    } else if (select.type === CHOICE.PLACE) {
      var phase = select.arg1;
      var special = select.arg2;
      set_prompt('Choose card to ' + (phase === 2 ? 'develop' : 'settle') + (special >= 0 ? ' using ' + card_info[special].name : ''));
      make_selectable(select.list);
      make_inactive('hand');
      action_restrict = restrict_num(0, 1);
      select_result = function() {
        var elms = get_cards_selected();
        return {
          result: elms.length ? elms[0] : -1
        };
      };
    } else if (select.type === CHOICE.PAYMENT) {
      var which = select.arg1;
      var mil_only = select.arg2;
      var mil_bonus = select.arg3;
      set_prompt(Module.ccall('choose_pay_prompt', 'string', ['number', 'number', 'number'], [which, mil_only, mil_bonus]));
      make_selectable(select.list, 'discard');
      make_selectable_power(select.special);
      make_inactive('hand');
      make_inactive('table0');
      action_restrict = function() {
        var list = get_cards_selected('hand');
        var special = get_cards_selected('table0');
        var buf = Module._get_callbuffer();
        list.forEach(function(e, i) {
          Module.setValue(buf + 4 * i, e, 'i32');
        });
        special.forEach(function(e, i) {
          Module.setValue(buf + 4 * (i + list.length), e, 'i32');
        });
        return Module._action_check_payment(which, list.length, special.length, mil_only, mil_bonus);
      };
      select_result = function() {
        return {
          list: get_cards_selected('hand'),
          special: get_cards_selected('table0'),
        }
      };
    } else if (select.type === CHOICE.GOOD) {
      var c_idx = select.special[0];
      var o_idx = select.special[1];
      var goods = select.list;
      var min = select.arg1;
      var max = select.arg2;
      set_prompt('Choose good' + plural(min * max) + ' to consume on ' + card_info[c_idx].name);
      make_selectable(select.list, 'good');
      make_inactive('table0');
      select_autoconfirm = max === 1;
      action_restrict = function() {
        var list = get_cards_selected('table0');
        if (list.length < min || list.length > max) return false;
        var buf = Module._get_callbuffer();
        list.forEach(function(e, i) {
          Module.setValue(buf + 4 * i, e, 'i32');
        });
        return Module._action_check_goods(c_idx, o_idx, list.length);
      }
    } else if (select.type === CHOICE.TRADE) {
      var no_bonus = select.arg1;
      set_prompt("Choose good to trade" + (no_bonus ? " (no bonuses)" : ""));
      make_selectable(select.list, 'good');
      action_restrict = restrict_num(1, 1);
    } else if (select.type === CHOICE.WINDFALL) {
      set_prompt("Choose windfall world to produce");
      make_selectable(select.list);
      make_inactive('table0');
      action_restrict = restrict_num(1, 1);
    } else if (select.type === CHOICE.CONSUME || select.type === CHOICE.PRODUCE || select.type === CHOICE.SETTLE) {
      var optional = select.type === CHOICE.SETTLE || select.type === CHOICE.CONSUME && select.arg1 > 0;
      var action_name = select.type === CHOICE.SETTLE ? 'Settle' : select.type === CHOICE.CONSUME ? 'Consume' : 'Produce';
      var list = select.list.map(function(e, i) {
        return ({
          card: select.list[i],
          power: select.special[i]
        });
      });
      list.forEach(function(e) {
        e.p = e.card < 0 ? { score: -1000, name: "Prestige Trade bonus" } : card_info[e.card].powers[e.power];
      });
      list = list.sort(function(a, b) { return b.p.score - a.p.score; });
      var opts = list.map(function(e) { return { name: e.p.name }; });
      if (optional) opts.push({ name: 'None (done with ' + action_name + ')' });
      set_prompt('Choose ' + action_name + ' power ' + gen_select(opts));
      select_result = function() {
        var v = select_value();
        return v === list.length ? {} : {
          list: [list[v].card],
          special: [list[v].power]
        };
      }
    } else if (select.type === CHOICE.CONSUME_HAND) {
      var c_idx = select.arg1;
      var o_idx = select.arg2;
      set_prompt("Choose cards to consume on " + (c_idx < 0 ? "Prestige Trade bonus" : card_info[c_idx].name));
      make_selectable(select.list, 'discard');
      action_restrict = function() {
        var list = get_cards_selected();
        var buf = Module._get_callbuffer();
        list.forEach(function(e, i) {
          Module.setValue(buf + 4 * i, e, 'i32');
        });
        return Module._action_check_consume(c_idx, o_idx, list.length);
      }
    } else if (select.type === CHOICE.LUCKY) {
      var opts = [1, 2, 3, 4, 5, 6, 7].map(function(e) {
        return {
          name: e,
          value: e
        };
      });
      select_autoconfirm = true;
      set_prompt('Choose Number: ' + gen_modal(opts));
      action_restrict = function() {
        return modalresult.length === 1
      };
      select_result = function() {
        return {
          result: modalresult[0]
        };
      };
    } else if (select.type === CHOICE.DISCARD_PRODUCE) {
      set_prompt('Choose discard to produce');
      make_selectable(select.list, 'discard')
      make_selectable(select.special);
      make_inactive('table0');
      select_result = function() {
        return {
          list: get_cards_selected('hand'),
          special: get_cards_selected('table0'),
        }
      };
      action_restrict = function() {
        var n = get_cards_selected('hand').length;
        var ns = get_cards_selected('table0').length;
        return n <= 1 && ns <= 1 && n === ns;
      };
    } else if (select.type === CHOICE.START) {
      decks.table0 = select.special.map(function(e, i) {
        return ({ index: e, sortkey: i });
      });
      set_prompt('Choose start world and hand discards');
      make_selectable(select.list, 'discard');
      make_selectable(select.special, settings.revstart ? 'discard' : 'normal');
      select_result = function() {
        return {
          list: get_cards_selected('hand'),
          special: get_cards_selected('table0', settings.revstart),
        }
      };
      action_restrict = function() {
        var list = get_cards_selected('hand');
        var special = get_cards_selected('table0', settings.revstart);
        var buf = Module._get_callbuffer();
        list.forEach(function(e, i) {
          Module.setValue(buf + 4 * i, e, 'i32');
        });
        special.forEach(function(e, i) {
          Module.setValue(buf + 4 * (i + list.length), e, 'i32');
        });
        return Module._action_check_start(list.length, special.length);
        // Note this just checks if n==2 and ns==1, Ancient Race is handled later
      };
    } else if (select.type === CHOICE.ANTE) {
      set_prompt('Choose card to ante');
      make_selectable(select.list, 'discard');
      action_restrict = restrict_num(0, 1);
      select_result = function() {
        var elms = get_cards_selected();
        return {
          result: elms.length ? elms[0] : -1
        };
      }
    } else if (select.type === CHOICE.KEEP) {
      set_prompt('Choose card to keep');
      decks.hand = decks.hand.concat(select.list.map(function(e, i) {
        return ({ index: e, sortkey: i + 90000000 });
      }));
      make_selectable(select.list);
      make_inactive('hand');
      action_restrict = restrict_num(1, 1);
      select_result = function() {
        return {
          result: get_cards_selected()[0]
        };
      }
    } else if (select.type === CHOICE.SAVE) {
      set_prompt('Choose card to save for later');
      var inhand = decks.hand.map(function(e) {
        return e.index;
      });
      var toadd = select.list.filter(function(e) {
        return inhand.indexOf(e) < 0;
      });
      decks.hand = decks.hand.concat(toadd.map(function(e, i) {
        return ({ index: e, sortkey: i + 90000000 });
      }));
      make_selectable(select.list);
      make_inactive('hand');
      action_restrict = restrict_num(1, 1);
    } else if (select.type === CHOICE.UPGRADE) {
      set_prompt('Choose world to replace');
      make_selectable(select.list);
      make_selectable(select.special, 'discard');
      make_inactive('hand');
      make_inactive('table0');
      action_restrict = function() {
        var list = get_cards_selected('hand');
        var special = get_cards_selected('table0');
        var n = list.length;
        var ns = special.length;
        if (!n && !ns) return true;
        if (n !== 1 || ns !== 1) return false;
        return Module._action_check_upgrade(list[0], special[0]) !== 0;
      }
      select_result = function() {
        return {
          list: get_cards_selected('hand'),
          special: get_cards_selected('table0'),
        }
      };
    } else if (select.type === CHOICE.DISCARD_PRESTIGE) {
      set_prompt('Choose card to discard for prestige');
      make_selectable(select.list, 'discard');
      action_restrict = restrict_num(0, 1);
    } else if (select.type === CHOICE.SEARCH_TYPE) {
      var opts = [
        "development providing +1 or +2 Military",
        "military windfall with 1 or 2 defense",
        "peaceful windfall with 1 or 2 cost",
        "world with Chromosome symbol",
        "world producing or coming with Alien good",
        "card consuming two or more goods",
        "military world with 5 or more defense",
        "6-cost development giving ? VPs",
        "card with takeover power"
      ].map(function(e) { return { name: e }; });
      set_prompt('Choose Search category ' + gen_select(opts));
      select_result = function() {
        return { result: select_value() };
      }
    } else if (select.type === CHOICE.SEARCH_KEEP) {
      var which = select.arg1;
      var opts = [ { name: 'Discard (keep searching)', value: 0 }, { name: 'Keep card', value: 1 } ];
      set_prompt('Choose to keep/discard ' + card_info[which].name + ' ' + gen_modal(opts));
      decks.hand.push({ index: which, sortkey: 90000000 });
      select_autoconfirm = true;
      action_restrict = function() { return modalresult.length === 1 };
      select_result = function() {
        return { result: modalresult[0] };
      }
    } else if (select.type === CHOICE.OORT_KIND) {
      var opts = [2, 3, 4, 5].map(function(e) {
        return { name: '<div class="kind kind' + e + '"></div>', value: e };
      });
      set_prompt('Choose Alien Oort Cloud Refinery kind ' + gen_modal(opts));
      select_autoconfirm = true;
      action_restrict = function() { return modalresult.length === 1 };
      select_result = function() {
        return { result: modalresult[0] };
      }
    } else if (select.type === CHOICE.TAKEOVER) {
      set_prompt("Choose world to takeover and power to use");
      make_selectable(select.list);
      make_selectable_power(select.special);
      make_inactive('hand');
      for (var i = 0; i < num_players; i++) make_inactive('table' + i);
      action_restrict = function () {
        var list = [];
        var special = get_cards_selected('table0');
        for (var i = 1; i < num_players; i++)
          list = list.concat(get_cards_selected('table' + i));
        var n = list.length;
        var ns = special.length;
        if (!n && !ns) return true;
        if (n !== 1 || ns !== 1) return false;
        return Module._action_check_takeover(list[0], special[0]) !== 0;
      };
      select_result = function () {
        for (var i = 1; i < num_players; i++) {
          var sel = get_cards_selected('table' + i);
          if (sel.length) return { special: get_cards_selected('table0'), result: sel[0] };
        }
        return { result: -1 };
      }
    } else if (select.type === CHOICE.DEFEND) {
      var which = select.arg1;
      var deficit = select.arg3 + 1;
      set_prompt("Choose defense for " + card_info[which].name + " (need " + deficit + " extra military)");
      make_selectable(select.list, 'discard');
      make_selectable_power(select.special);
      make_inactive('hand');
      make_inactive('table0');
      action_restrict = function () {
        var list = get_cards_selected('hand');
        var special = get_cards_selected('table0');
        var buf = Module._get_callbuffer();
        list.forEach(function(e, i) {
          Module.setValue(buf + 4 * i, e, 'i32');
        });
        special.forEach(function(e, i) {
          Module.setValue(buf + 4 * (i + list.length), e, 'i32');
        });
        return Module._action_check_defend(list.length, special.length) !== 0;
      };
      select_result = function () {
        return {
          list: get_cards_selected('hand'),
          special: get_cards_selected('table0'),
        }
      }
    } else if (select.type === CHOICE.TAKEOVER_PREVENT) {
      var opts = select.list.map(function (e, i) {
        return { name: card_info[e].name + ' using ' + card_info[select.special[i]].name };
      });
      opts.push( { name: "None (allow all takeovers)" });
      set_prompt('Choose takeover to prevent: ' + gen_select(opts));
      select_result = function () {
        var i = select_value();
        return {
          list: select.list.slice(i, i + 1),
          special: select.special.slice(i, i + 1),
        }
      }
    } else {
      set_prompt('Unknown select type: ' + select.type);
      console.log(select);
    }
  }
  function totalOffsetTop(a) {
    a = document.getElementById(a);
    for (var r = 0; a; a = a.offsetParent) r += a.offsetTop;
    return r;
  }
  function update_scroll() {
    var bottom = window.innerHeight + (document.documentElement.scrollTop || document.body.scrollTop);
    for (var i = 0; i < num_players; i++) {
      var visible = bottom - totalOffsetTop('player_status' + i);
      var pos = (num_players - i) * 58;
      document.getElementById('player_over' + i).classList[visible > pos ? 'add' : 'remove']('hidden');
    }
  }

  function set_scroll() {
    hide(document.getElementById('status_over'), !settings.pullup);
    if (settings.pullup) {
      window.addEventListener("scroll", update_scroll);
      update_scroll();
    } else {
      window.removeEventListener("scroll", update_scroll);
    }
  }
  var lastWidth = 0;
  window.addEventListener("resize", function() {
    if (window.innerWidth !== lastWidth) display();
    update_scroll();
  });
  var keyAccels = {};
  var update_key_accels = function (elem) {
    var e = elem.querySelectorAll('[data-accel]');
    keyAccels = {};
    for (var i = 0; i < e.length; i++)
      keyAccels[e[i].getAttribute('data-accel')] = e[i];
  };
  var show_accels = false;
  GUI.toggle_showaccels = function () {
    show_accels = !show_accels;
    if (show_accels) {
      show_card_key_accels();
      return;
    }
    var e = document.getElementById('board').querySelectorAll('.cardaccel');
    for (var i = 0; i < e.length; i++) {
      e[i].parentNode.removeChild(e[i]);
    }
  }
  var keycode_name = function(c) {
    var mod = '';
    if (c.substring(0, 6) === 'shift-') c = c.substring(6), mod = 'Shift ';
    if (c >= 112 && c <= 123) return mod + 'F' + (c - 111);
    if (c >= 48 && c <= 90) return mod + String.fromCharCode(c);
    return mod + 'Unknown';
  };
  var show_card_key_accels = function (elem) {
    if (!show_accels) return;
    var e = document.getElementById('board').querySelectorAll('[data-accel].card');
    for (var i = 0; i < e.length; i++) {
      e[i].innerHTML += '<div class="cardaccel">' + keycode_name(e[i].getAttribute('data-accel')) + '</div>'
    }
  };
  window.addEventListener("keydown", function(ev) {
    var prefix = '';
    if (ev.ctrlKey) prefix += 'ctrl-';
    if (ev.shiftKey) prefix += 'shift-';
    if (ev.altKey) prefix += 'alt-';
    if (ev.metaKey) prefix += 'meta-';
    var keycode = prefix + ev.keyCode;
    var target = keyAccels[keycode];
    if (!target || target.disabled || hide(target)) return;
    if (target.tagName === "OPTION")
      target.selected = 'selected';
    else
      target.click();
    ev.preventDefault();
  });

  var COLOR_NAMES = ["Blue", "Red", "Green", "Yellow", "Cyan", "Purple" ];
  function player_name(p) { return COLOR_NAMES[(p + settings.color) % 6]; }
  function player_class(p) { return 'player' + p + ' player_color' + (p + settings.color) % 6; }
  function update_player_classes() {
    for (var i = 0; i < 6; i++) {
      var e = document.querySelectorAll('.player' + i);
      for (var j = 0; j < e.length; j++) e[j].className = player_class(i);
    }
    document.body.classList[settings.bigbody ? 'add' : 'remove']('big');
  }

  var old_pos = {};
  var old_goods = {};
  var prev_game_status;

  function display(animate) {
    var ICON = {
      NO_ACT: 10,
      HANDSIZE: 11,
      VP: 12,
      MILITARY: 13,
      PRESTIGE: 14,
      WAITING: 15,
      READY: 16,
      OPTION: 17,
      DISCARD: 18,
      VP_EMPTY: 19,
      DISCOUNT: 20,
      DRAW: 21,
      DRAW_EMPTY: 22,
      EXPLORE: 23,
      CONSUME: 24,
    };
    var new_pos = {};
    animate = animate && settings.animate > 0;

    function makeactionicon(id, enabled, current) {
      var cl = "icon";
      var has_prestige = (id & 128) === 128;
      if (!enabled) cl += " inactiveaction";
      if (current) cl += " currentaction";
      id = id & 127;
      if (id === 4 || id === 6) id--;
      var content = has_prestige ? '<img class="prestige_icon" src="' + image_from_data(3014) + '">' : '<div></div>';
      return '<td class="' + cl + '" style="background-image: url(' + image_from_data(3000 + id) + ')">' + content + '</td>';
    }

    function makeicon(id, content, diff, et) {
      var bg = id !== undefined ? ' style="background-image: url(' + image_from_data(3000 + id) + ')"' : '';
      var modified = diff && animate && content ? ' class="modified"' : '';
      et = et ? ' ' + et.join(' ') : '';
      return '<td class="icon' + et + '"' + bg + '><div' + modified + '>' + (content || '&nbsp;') + '</div></td>';
    }
    function makemilitaryicon(value, diff, et) {
      if (!value) return makeicon();
      var modified = diff && animate ? ' class="modified"' : '';
      if (value > 0) value = '+' + value;
      et = et ? ' ' + et : '';
      return '<td class="icon"><div class="military' + et + '"><div><div' + modified + '>' + value + '</div></div></div></td>';
    }
    function makegoal(id, et) {
      if (id >= 12) et += ' goalbig';
      return '<td class="goal goal' + et + '"><div><img src="' + image_from_data(2000 + id) + '"></div></td>';
    }

    function is_scavengers(c) { return card_info[c.index].image === SCAVENGERS; }
    var keys = { true: KEYACCELS(0).slice(), false: KEYACCELS(1).slice() };
    function makecard(c, i) {
      var pos = i * cardspacing, top = 0, num_goods = c.num_goods;
      new_pos[c.index] = {
        left: pos,
        row: j,
        goods: num_goods
      };
      if (animate) {
        var old = old_pos[c.index];
        if (old) {
          pos = old.left;
          top = document.getElementById(old.row).offsetTop - document.getElementById(j).offsetTop;
          num_goods = old.goods;
        } else {
          pos = cardelem.offsetWidth;
        }
      }
      var extra = card_classes[c.index] ? ' ' + card_classes[c.index] : '';
      var key = '';
      if (selectable_cards[c.index] && keys[j === 'hand'].length) key = ' data-accel="' + keys[j === 'hand'].shift() + '"';
      var txt = '<div class="card' + extra + '" style="left:' + pos + 'px;top:' + top + 'px" id="card' + c.index + '"' + key + '><img class="cardface" src="' + image_from_data(card_info[c.index].image) + '">';
      for (var i = 0; i < c.num_goods || i < num_goods; i++) {
        var gpos = 70 + i * 15;
        if (i >= num_goods) gpos += 280 - 72;
        txt += '<img class="good" style="top:' + gpos + 'px" src="' + image_from_data(1000) + '">';
      }
      if (is_scavengers(c) && decks.saved.length) {
        var spos = Math.min(cardspacing - 34, 156);
	txt += '<div id="savednum" style="left:'+ spos +'px;background-image: url(' + image_from_data(1000) + ')">' + decks.saved.length + '</div>';
      }
      if (selectable_cards[c.index] === 'discard')
        txt += '<img class="discard" src="' + image_from_data(3000 + ICON.DISCARD) + '">';
      if (c.vp !== undefined) txt += '<div class="vptooltip">'+c.vp+'</div>';
      if (c.trade_value && selectable_cards[c.index]) txt += '<div class="tradevalue">$'+c.trade_value+'</div>';
      txt += '<div class="frame"></div></div>';
      return txt;
    }
    function makeactioncard(c, i) {
      var pos = i * cardspacing;
      var id = c.value instanceof Array ? c.value[0] : (c.value || 10);
      var key = 'data-accel="' + c.accel + '"';
      if (id === 4 || id === 6) id--;
      var txt = '<div class="card modalopt" style="left:' + pos + 'px;" id="modalopt' + i + '"' + key + '><img class="cardface" src="' + image_from_data(id + 4000) + '">';
      txt += '<img class="prestigeaction" src="' + image_from_data(4010) + '">';
      txt += '<div class="frame"></div></div>';
      return txt;
    }

    function fill_game_summary() {
      function makesumicon(id, content) {
        var bg = id !== undefined ? '<img src="' + image_from_data(3000 + id) + '">' : '';
        return '<td>' + bg + '<span>' + (content || '&nbsp;') + '</span></td>';
      }
      var t = '<tr class="head"><td></td>';
      t += makesumicon(ICON.VP);
      t += makesumicon(5);
      t += makesumicon(3);
      t += makesumicon(3, '6');
      if (game_status.goals.length) t += '<td>Goals</td>';
      if (exp_level === 3) t += makesumicon(ICON.PRESTIGE);
      t += '<td>Sum</td>';
      var players = [];
      var player_tiebreak = [];
      for (var i = 0; i < num_players; i++) {
        player_tiebreak[i] = game_status.player[i].hand_size;
        decks['table'+i].forEach(function (e) { player_tiebreak[i] += e.num_goods; });
      }
      var score = function(a) { return game_status.player[a].total_vp * 1000 + player_tiebreak[a]; };
      for (var i = 0; i < num_players; i++) players.push(i);
      players.sort(function(a, b) { return score(b) - score(a); });
      t += players.map(function(e, i) {
        var p = game_status.player[e];
        var pos = players.filter(function(a) { return score(a) > score(e); }).length + 1;
        var cells = [pos + '.', p.vp, p.world_vp, p.dev_vp, p.dev6_vp];
        if (game_status.goals.length) cells.push(p.goal_vp);
        if (exp_level === 3) cells.push(p.prestige);
        cells.push(p.total_vp);
        return '<tr class="' + player_class(e) + '">' + cells.map(function(e) { return '<td>' + e + '</td>'; }).join('');
      }).join('');
      document.getElementById('gamesummary').innerHTML = t;
    }
    var cardspacing;
    var cardelem;
    function set_spacing(a) {
      cardspacing = a.length > 1 ? (cardelem.offsetWidth - 210) / (a.length - 1) : 210;
      if (cardspacing > 210) cardspacing = 210;
    }
    lastWidth = window.innerWidth;
    var scav_pos = decks.saved.length ? decks.table0.map(is_scavengers).indexOf(true) : -1;
    for (var j in decks) {
      cardelem = document.getElementById(j);
      set_spacing(decks[j]);
      if (j === 'saved') {
        if (scav_pos < 0) {
          cardelem.innerHTML = '';
          continue;
        }
        if (!cardelem.classList.contains('showsaved')) cardspacing = 0;
      }
      decks[j] = decks[j].sort(function(a, b) { return a.sortkey - b.sortkey; });
      cardelem.innerHTML = decks[j].map(makecard).join('');
    }
    cardelem = document.getElementById('actionhand');
    if (action_cards) {
      set_spacing(action_cards);
      cardelem.innerHTML = action_cards.map(makeactioncard).join('');
    } else {
      cardelem.innerHTML = '';
    }
    cardelem.style.zIndex = action_cards ? 0 : -1;
    document.getElementById('hand').style.zIndex = action_cards ? -1 : 0;
    if (scav_pos >= 0)
      document.getElementById('savednum').addEventListener('click', toggle_showsaved, false);
    if (animate) {
      for (var j in new_pos) {
        var card = document.getElementById('card' + j);
        getComputedStyle(card).left;
        card.style.left = new_pos[j].left + 'px';
        card.style.top = '0px';
        var goods = card.getElementsByClassName('good');
        for (var k = 0; k < goods.length; k++) {
          var gpos = 70 + k * 15;
          if (k >= new_pos[j].goods) gpos += 210;
          goods[k].style.top = gpos + 'px';
        }
      }
      // for (var j in old_pos) if (!(j in new_pos)) { // Add discarded cards animation?
      // }
    }
    old_pos = new_pos;
    prev_game_status = prev_game_status || game_status;
    function pdiff(s) { return game_status.player[j][s] - prev_game_status.player[j][s]; };
    var txt = makeicon(ICON.DRAW, '<b>' + game_status.deck_size + '</b><br>Deck');
    txt += makeicon(ICON.HANDSIZE, '<b>' + game_status.discard_size + '</b><br>Discard');
    txt += makeicon(game_status.vp_stack > 0 ? ICON.VP : ICON.VP_EMPTY, '<b>' + game_status.vp_stack + '</b><br>VP');
    txt += makeicon();
    document.getElementById('game_status').innerHTML = txt;
    document.getElementById('action_status').innerHTML =
    (advanced ? [23, 3, 3, 5, 5, 24, 9] : [23, 3, 5, 24, 9]).map(function(e, j) {
      return makeactionicon(e, game_status.phases[j], j === game_status.current_phase);
    }).join('') + makeicon();
    var goal_progress = [];
    var goal_claimed = [];
    var goal_maximum = game_status.goals.map(function(e){return e.min;});
    txt = '<table><tr>';
    txt += game_status.goals.map(function(e,i){
      var claimed = game_status.player.some(function (p) {return p.goals_claimed[i] > 0;});
      var et = claimed ? ' class="claimed"' : '';
      goal_claimed[i] = claimed;
      game_status.player.forEach(function(e){
        if (e.goals_progress[i] > goal_maximum[i]) goal_maximum[i] = e.goals_progress[i];
      });
      goal_progress[i] = game_status.player.map(function (e,i){return i;}).sort(function (a,b) {
        return (game_status.player[b].goals_progress[i] * 4 + game_status.player[b].goals_claimed[i]) -
               (game_status.player[a].goals_progress[i] * 4 + game_status.player[a].goals_claimed[i]);
      });
      return '<th'+et+'><img src="' + image_from_data(2000 + e.idx) + '"></th>';
    }).join('');
    for (var j = 0; j < num_players; j++) {
      txt += '<tr>'
      txt += game_status.goals.map(function(e,i){
        var p_nr = goal_progress[i][j];
        var p = game_status.player[p_nr];
        if (p.goals_progress[i] <= 0 || (i < 4 && goal_claimed[i])) return '<td></td>';
        var perc = p.goals_progress[i] / goal_maximum[i] * 100;
        return '<td><span style="width:'+perc+'%" class="'+player_class(p_nr)+'">'+p.goals_progress[i]+'&nbsp;</span></td>';
      }).join('');
    }
    txt += '</table>';
    document.getElementById('goals').innerHTML = txt;
    document.getElementById('goalsbutton').innerHTML = '<table><tr>' + game_status.goals.map(function(e,i){
      return i < 4 && goal_claimed[i] ? '' : makegoal(e.idx, goal_claimed[i] ? 1 : 0);
    }).join('') + '</table>';
    for (var j = 0; j < num_players; j++) {
      var p = game_status.player[j];
      var txt = makeicon(ICON.VP, '<b style="font-size:20px">' + p.total_vp + '</b><br>' + p.vp, pdiff('total_vp'));
      if (exp_level === 3) {
        var et = [];
        if (p.prestige_leader) et.push('p_leader');
        if (p.prestige_used) et.push('p_used');
        if (p.prestige_turn) et.push('p_turn');
        txt += makeicon(ICON.PRESTIGE, '<div class="prestige"><div>' + p.prestige + '</div></div>', pdiff('prestige'), et);
      }
      txt += makeicon(ICON.DRAW, '<b style="font-size:25px">' + p.table_size + '</b>', pdiff('table_size'));
      txt += makeicon(ICON.HANDSIZE, '<b style="font-size:25px">' + p.hand_size + '</b>', pdiff('hand_size'));
      txt += makemilitaryicon(p.military,pdiff('military'));
      txt += makemilitaryicon(p.military_vsrebel,pdiff('military_vsrebel'),'vsrebel');
      if (takeovers) {
        txt += makeicon(undefined, (p.has_imperium ? '<div class="hasimperium"></div>' : '') +
                                   (p.has_rebel ? '<div class="hasrebel"></div>' : ''));
      }
      if (p.action >= 0) txt += makeactionicon(p.action, true, false);
      else txt += makeicon();
      if (advanced && p.second_action >= 0) txt += makeactionicon(p.second_action, true, false);
      else if (advanced) txt += makeicon();
      for (var i = 0; i < game_status.goals.length; i++)
        if (p.goals_claimed[i])
          txt += makegoal(game_status.goals[i].idx, p.goals_claimed[i]);
      document.getElementById('player_status' + j).innerHTML = txt;
      document.getElementById('player_status_over' + j).innerHTML = txt;
    }
    fill_game_summary();
    update_action_sensitivity(true);
    update_key_accels(document.getElementById('gamescreen'));
    show_card_key_accels();
    prev_game_status = game_status;
  }

  var do_send = GUI.do_send = function() {
    var res = select_result();
    var list = res.list || [];
    var special = res.special || [];
    var len = 4 + list.length + special.length;
    var ptr = Module._selection_result(len);
    var a = Module.HEAP32.subarray((ptr >> 2), (ptr >> 2) + len);
    var i = 0;
    a[i++] = select.type;
    a[i++] = res.result || 0;
    a[i++] = list.length;
    list.forEach(function(e) { a[i++] = e; });
    a[i++] = special.length;
    special.forEach(function(e) { a[i++] = e; });
    no_select();
    display();
    setTimeout(function() {
      Module._continue_game(-1);
      get_status();
      display(true);
    }, 50);
  }
  var do_undo = GUI.do_undo = function(v) {
    //    if (!game_over && (v === RESTART.NEW || v === RESTART.UNDO_GAME))
    //	if (!confirm(v === RESTART.NEW ? 'New Game' : 'Restart Game')) return;
    game_over = false;
    no_select();
    display();
    setTimeout(function() {
      set_screen('gamescreen');
      clear_log();
      Module._continue_game(v);
      get_status();
      display();
    }, 50);
  }

  function get_status() {
    var MSG = {
      CARDINFO:0,
      GAMESTATE:1,
      LOGLINE:2,
      CHOICE:3,
      GAMEOVER:4,
    };
    var ptr = Module._get_status_data();
    var datasize = Module._get_status_data_size();
    var array = Module.HEAP32.subarray((ptr >> 2), (ptr >> 2) + datasize);
    var i = 0;
    select = undefined;
    while (i < datasize) {
      var msgtype = array[i++];
      if (msgtype == MSG.CHOICE) {
        var nl = array[i + 1];
        var ns = array[i + 2];
        select = {
          type: array[i],
          arg1: array[i + 3],
          arg2: array[i + 4],
          arg3: array[i + 5],
          list: [],
          special: [],
        }
        i += 6;
        for (var j = 0; j < nl; j++) select.list.push(array[i++]);
        for (var j = 0; j < ns; j++) select.special.push(array[i++]);
      } else if (msgtype == MSG.GAMEOVER) {
        game_over = true;
      } else if (msgtype == MSG.GAMESTATE) {
        decks = { hand: [], saved: [] };
        for (var j = 0; j < num_players; j++) decks['table' + j] = [];
        while (array[i] >= 0) {
          var where = array[i + 2];
          where = where === -2 ? 'saved' : where === -1 ? 'hand' : 'table' + where;
          var card = {
            index: array[i],
            image: array[i + 1],
            sortkey: array[i + 3],
            num_goods: array[i + 4] & 0xffff,
            trade_value: array[i + 4] >> 16,
            vp: array[i + 5] >= 0 ? array[i + 5] : undefined,
          };
          decks[where].push(card);
          i += 6;
        }
        i++;
        game_status = {
          deck_size: array[i++],
          discard_size: array[i++],
          vp_stack: array[i++],
          phases: [],
          player: [],
          goals: [],
        }
        for (var j = 0; j < (advanced ? 7 : 5); j++) {
          var v = array[i++];
          game_status.phases[j] = v > 0;
          if (v > 1) game_status.current_phase = j;
        }
        while (array[i] >= 0) {
          game_status.goals.push({
            idx: array[i++],
            min: array[i++],
          });
        }
        i++;
        for (var j = 0; j < num_players; j++) {
          var t, p;
          game_status.player.push(p = {
            action: array[i++],
            second_action: array[i++],
            vp: array[i++],
            total_vp: array[i++],
            hand_size: array[i++],
            military: array[i++],
            military_vsrebel: array[i++],
            has_imperium: (array[i] & 2) !== 0,
            has_rebel: (array[i++] & 1) !== 0,
            prestige: (t = array[i++]) >> 3,
            prestige_leader: (t & 4) !== 0,
            prestige_turn: (t & 2) !== 0,
            prestige_used: (t & 1) !== 0,
            goal_vp: array[i++],
            world_vp: array[i++],
            dev_vp: array[i++],
            dev6_vp: array[i++],
            table_size: decks['table'+j].length,
            goals_claimed: [],
            goals_progress: [],
          });
          for (var k = 0; k < game_status.goals.length; k++) {
            p.goals_claimed[k] = array[i++];
            p.goals_progress[k] = array[i++];
          }
        }
      } else if (msgtype == MSG.LOGLINE) {
        add_log({
          tag: Module.UTF8ToString(array[i++]),
          msg: Module.UTF8ToString(array[i++])
        });
      } else if (msgtype == MSG.CARDINFO) {
        var num = array[i++];
        for (var k = 0; k < num; k++) {
        var c = {
          name: Module.UTF8ToString(array[i++]),
          image: array[i++],
          discard: array[i++],
          powers: []
        };
        var npow = array[i++];
        for (var j = 0; j < npow; j++) {
          c.powers[j] = {
            name: Module.UTF8ToString(array[i++]),
            score: array[i++]
          };
        }
        card_info[k] = c;
        }
      } else {
          console.log("Unknown message type: " + msgtype);
          return;
      }
    }
    do_select();
    var autosave = FS.readFile('autosave.rftg', { encoding: 'utf8' });
    if (localStorage)
      localStorage.setItem('autosave.rftg', autosave);
    document.getElementById('exportsavelink').href = 'data:text/plain;base64,' + window.btoa(autosave);
  }
  function add_log(line) {
    var table = document.getElementById('gamelogtext');
    var cell = table.insertRow(-1).insertCell(0);
    cell.classList.add('logline');
    if (line.tag) cell.classList.add(line.tag);
    cell.innerHTML = line.msg.replace(/\[P(\d)\]/, function(m, p) { return player_name(parseInt(p)); });
    var logdiv = document.getElementById('gamelog');
    logdiv.scrollTop = logdiv.scrollHeight;
  }
  function clear_log() {
    document.getElementById('gamelogtext').innerHTML = '';
  }

  function read_images(i8) {
    var pos = 4;
    while (i8[pos]) {
      var t = i8[pos++];
      var num = 0,
        len = 0;
      if (t !== 2)
        while (i8[pos++]) num = num * 10 + i8[pos - 1] - 48;
      while (i8[pos++]) len = len * 10 + i8[pos - 1] - 48;
      images[(t - 1) * 1000 + num] = {
        pos: pos,
        len: len
      };
      pos += len;
    }
  }
  function update_campaign() {
    var sel = document.getElementById('campaign_name').value;
    document.getElementById('campaign_info').innerHTML = sel === '' ? '' : campaigns[sel].desc.join(' ');
  }
  function read_campaigns(content) {
    var cur;
    content.split('\n').forEach(function (e) {
      var r = e.match(/^([A-Z]):(.*)/);
      if (!r) return;
      if (r[1] === 'N') {
        cur = { name: r[2], desc: [] };
        campaigns.push(cur);
      } else if (r[1] === 'D' && cur) {
	cur.desc.push(r[2]);
      } else if (r[1] === 'O' && cur) {
	cur.options = r[2].split(':').map(function (e) { return parseInt(e); });
      }
    });
    var campaign_name = document.getElementById('campaign_name');
    campaign_name.innerHTML = campaigns.map(function (e, i) {
      var selected = campaign === e.name ? ' selected' : '';
      return '<option value="' + i + '"' + selected + '>' + e.name + '</option>';
    }).join('');
    campaign_name.addEventListener('change', update_campaign);
    update_campaign();
  }

  GUI.print = function(text) {
    if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
    console.log(text);
  }
  GUI.printErr = function(text) {
    if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
    alert(text);
    console.error(text);
  }
  GUI.params = function() {
    return params;
  }
  GUI.initFS = function(FS) {
    var net_name = exp_level + '.' + num_players;
    if (advanced) net_name += 'a';
    FS.createPreloadedFile('/', 'cards.txt', 'cards.txt', true, false);
    FS.createPreloadedFile('/', 'campaign.txt', 'campaign.txt', true, false);
    FS.mkdir('/network');
    FS.createPreloadedFile('/network/', 'rftg.eval.' + net_name + '.net', 'network/rftg.eval.' + net_name + '.net', true, false);
    FS.createPreloadedFile('/network/', 'rftg.role.' + net_name + '.net', 'network/rftg.role.' + net_name + '.net', true, false);
    FS.createPreloadedFile('/', 'images.data', 'images.data', true, false);
    if (save) FS.createDataFile('/', 'autosave.rftg', save, true, true);
  }
  GUI.firstRun = function() {
    read_images(images_data = FS.readFile('images.data'));
    read_campaigns(FS.readFile('campaign.txt', { encoding: 'utf8' }));
    set_screen('gamescreen');
    get_status();
    display();
    if (game_over) set_screen('menuscreen');
  }
  return GUI;
})();

var Module = {
  arguments: GUI.params(),
  preRun: function() { GUI.initFS(FS); },
  postRun: [GUI.firstRun],
  print: GUI.print,
  printErr: GUI.printErr,
  setStatus: function(text) { document.getElementById('loadingmsg').innerHTML = text; },
  totalDependencies: 0,
  monitorRunDependencies: function(left) {
    Module.setStatus('Loading...');
    var bar = document.getElementById('progressbar');
    this.totalDependencies = Math.max(this.totalDependencies, left);
    var ratio = this.totalDependencies ? (this.totalDependencies - left) / this.totalDependencies : 0;
    bar.style.width = ratio * 100 + '%';
  }
};

(function (prefix) {
  var appCache = window.applicationCache;
  var con = document.getElementById(prefix+'container');
  var prog = document.getElementById(prefix+'progress');
  var elem1 = document.getElementById(prefix+'status1');
  var elem2 = document.getElementById(prefix+'status2');
  function appCacheMsg(m, proc, ready) {
    if (!m) {
      con.hidden = true;
      return;
    }
    con.hidden = false;
    prog.style.width = proc ? proc + '%' : 0; 
    elem1.innerHTML = m;
    elem2.innerHTML = m;
  }
  appCache.addEventListener('cached', function() {
    appCacheMsg();
  } , false);
  appCache.addEventListener('progress', function(e) {
    appCacheMsg('UPDATING', e.total ? Math.ceil(e.loaded*100/e.total) : 0)
  }, false);
  appCache.addEventListener('updateready', function() {
    appCacheMsg('RESTART');
    con.addEventListener('click', function() { location.reload(); }, false);
  }, false);
  appCache.addEventListener('error', function (e) {
    appCacheMsg('ERROR');
    con.addEventListener('click', function() { con.hidden = true; alert(e.message); }, false);
    setTimeout(function() { con.hidden = true; }, 10000);
    console.error('Failed updating cache.',e);
  }, false);
})('cache');

</script>
    <script async type="text/javascript" src="rftg.js"></script>
  </body>
</html>
